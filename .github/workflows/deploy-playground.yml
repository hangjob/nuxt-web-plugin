name: Deploy Playground

on:
  push:
    branches: [main] # 仅 main 分支变动时触发
    paths:
      - 'playground/**' # 仅 playground 目录变动时触发
      - 'src/**'        # 或源码变动时
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install Dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Build Playground (Static)
        run: |
          pnpm run dev:prepare
          cd playground
          pnpm generate # 使用 nuxi generate 生成静态文件

      - name: Deploy to Server
        uses: easingthemes/ssh-deploy@main
        with:
          # 必填: SSH 私钥 (对应服务器上 ~/.ssh/authorized_keys 中的公钥)
          SSH_PRIVATE_KEY: ${{ secrets.SERVER_SSH_KEY }}
          
          # 选填: rsync 参数 (默认包含递归、压缩、删除不存在的文件等)
          ARGS: "-rlgoDzvc -i --delete"
          
          # 必填: 本地构建产物路径 (Nuxt 静态生成的默认输出目录)
          SOURCE: "playground/.output/public/"
          
          # 必填: 目标服务器 IP 或域名
          REMOTE_HOST: ${{ secrets.SERVER_HOST }}
          
          # 必填: SSH 登录用户名 (建议使用非 root 用户)
          REMOTE_USER: ${{ secrets.SERVER_USER }}
          
          # 必填: 远程服务器上的部署目标目录 (需确保 SSH 用户有写入权限)
          # 例如: /www/wwwroot/demo.nuxt-plugin.com
          TARGET: ${{ secrets.SERVER_TARGET }}

